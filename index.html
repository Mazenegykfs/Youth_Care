<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Column Selector & Exporter</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e0f2fe; /* Light blue background */
            margin: 0;
            padding: 0;
            transition: all 0.5s ease;
        }
        .header-bar {
            background-color: #1e3a8a; /* Darker blue for header */
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom-left-radius: 0.75rem;
            border-bottom-right-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .header-content {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .language-switcher {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            font-weight: 600;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #2196F3;
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        .header-title-container {
            flex-grow: 1;
            display: flex;
            justify-content: flex-start;
            align-items: center;
        }
        .header-main-title {
            font-weight: 700;
            font-size: 1.25rem;
            margin: 0;
            line-height: 1.2;
            text-align: left;
        }
        .header-subtitle {
            font-weight: 400;
            font-size: 0.9rem;
            margin: 0;
            text-align: left;
        }
        .header-logo {
            height: 60px;
            width: auto;
            border-radius: 50%;
            margin-right: 1rem;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }
        [dir="rtl"] .header-logo {
            margin-right: 0;
            margin-left: 1rem;
        }
        [dir="rtl"] .header-title-container {
            justify-content: flex-end;
        }
        .main-container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            margin-top: 2rem;
            margin-bottom: 2rem;
            transition: all 0.5s ease;
        }
        .action-button {
            background-color: #10b981;
            color: white;
            font-weight: 600;
            padding: 1rem 2rem;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s ease;
            font-size: 1.1rem;
        }
        .action-button:hover {
            background-color: #059669;
        }
        .action-button:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }
        .red-button {
            background-color: #ef4444;
            color: white;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s ease;
        }
        .red-button:hover {
            background-color: #dc2626;
        }
        .column-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: #bfdbfe;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            font-weight: 500;
            cursor: grab;
        }
        .column-item.selected {
            background-color: #93c5fd;
            border: 2px solid #3b82f6;
        }
        .column-control-button {
            background-color: #3b82f6;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.25rem;
            border: none;
            cursor: pointer;
            margin-left: 0.5rem;
            transition: background-color 0.3s ease;
        }
        [dir="rtl"] .column-control-button {
            margin-left: 0;
            margin-right: 0.5rem;
        }
        .column-control-button:hover {
            background-color: #2563eb;
        }
        .section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background-color: #f8fafc;
            border-radius: 0.75rem;
            border: 2px solid #e2e8f0;
        }
        .section h2 {
            color: #1e3a8a;
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }
        .grid-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }
        .column-list {
            border: 2px solid #cbd5e1;
            border-radius: 0.5rem;
            padding: 1rem;
            height: 300px;
            overflow-y: auto;
            background-color: white;
        }
        .table-container {
            overflow-x: auto;
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
            margin-top: 1rem;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            border-radius: 0.75rem;
        }
        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #d1e5f8;
        }
        [dir="rtl"] th, [dir="rtl"] td {
            text-align: right;
        }
        th {
            background-color: #a7d9fc;
            font-weight: 600;
            color: #1f2937;
            position: relative;
        }
        th .filter-icon {
            cursor: pointer;
            font-size: 0.9em;
            margin-left: 0.5rem;
            vertical-align: middle;
            color: #1e40af;
        }
        [dir="rtl"] th .filter-icon {
            margin-left: 0;
            margin-right: 0.5rem;
        }
        th.sorted-asc .sort-icon::after { content: '▲'; }
        th.sorted-desc .sort-icon::after { content: '▼'; }
        .filter-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            z-index: 10;
            background-color: #ffffff;
            border: 1px solid #cbd5e1;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 0.75rem;
            min-width: 150px;
            max-height: 250px;
            overflow-y: auto;
        }
        [dir="rtl"] .filter-dropdown {
            left: auto;
            right: 0;
        }
        .filter-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .filter-buttons {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }
        tr:nth-child(even) {
            background-color: #e3f5fe;
        }
        tr:hover {
            background-color: #d1ecfd;
        }
        .loading {
            display: none;
            text-align: center;
            margin-top: 15px;
            color: #3b82f6;
            font-weight: 600;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .status-message {
            text-align: center;
            margin-top: 15px;
            padding: 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
        }
        .status-success {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }
        .status-error {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }
        .status-info {
            background-color: #dbeafe;
            color: #1e40af;
            border: 1px solid #3b82f6;
        }
        .file-input {
            width: 100%;
            padding: 1rem;
            border: 2px dashed #cbd5e1;
            border-radius: 0.5rem;
            background-color: white;
            font-size: 1rem;
            cursor: pointer;
        }
        .file-input:hover {
            border-color: #3b82f6;
            background-color: #f8fafc;
        }
        .button-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }
        .hidden {
            display: none;
        }
        h1 {
            text-align: center;
            color: #1e3a8a;
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 2rem;
        }
        h3 {
            color: #1e40af;
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }
        .move-buttons {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            justify-content: flex-end;
        }
        [dir="rtl"] .move-buttons {
            justify-content: flex-start;
        }
        .control-group {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        .control-group label {
            font-weight: 500;
        }
        .control-group select, .control-group input[type="text"] {
            padding: 0.5rem;
            border-radius: 0.25rem;
            border: 1px solid #cbd5e1;
            flex-grow: 1;
        }
        .control-group input[type="radio"] {
            margin-right: 0.5rem;
        }
        [dir="rtl"] .control-group input[type="radio"] {
            margin-right: 0;
            margin-left: 0.5rem;
        }
        .main-content-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .language-switcher-container {
            align-self: flex-end;
            margin-top: 1rem;
            margin-bottom: -1rem;
        }
        @media (max-width: 768px) {
            .grid-container {
                grid-template-columns: 1fr;
            }
            .button-group {
                flex-direction: column;
            }
            .action-button {
                width: 100%;
            }
            .control-group {
                flex-direction: column;
                align-items: stretch;
            }
            .language-switcher-container {
                align-self: center;
            }
        }
    </style>
</head>
<body>
    <div class="header-bar">
        <div class="header-title-container">
            <div class="header-main-title">Developed by Dr. Mazen Badawy</div>
            <div class="header-subtitle">Doctorate of English Teaching and Testing</div>
        </div>
        <img src="00.png" alt="Logo" class="header-logo">
    </div>
    <div class="main-content-wrapper">
        <div class="language-switcher-container">
            <div class="language-switcher">
                <span>EN</span>
                <label class="switch">
                    <input type="checkbox" id="languageSwitch">
                    <span class="slider"></span>
                </label>
                <span>AR</span>
            </div>
        </div>
        <div class="main-container">
            <h1 id="main-title">Column Selection and Data Export</h1>

            <section id="uploadSection" class="section">
                <h2 id="upload-title">Upload Your Data File</h2>
                <input type="file" id="fileInput" accept=".csv, .xlsx" class="file-input" />
            </section>

            <section id="columnSelectionSection" class="section hidden">
                <h2 id="select-title">Select and Order Columns</h2>
                <div class="grid-container">
                    <div>
                        <h3 id="available-columns-title">Available Columns</h3>
                        <div id="availableColumnsList" class="column-list">
                            <!-- Available columns will be populated here -->
                        </div>
                    </div>
                    <div>
                        <h3 id="selected-columns-title">Selected Columns (Order)</h3>
                        <div id="selectedColumnsList" class="column-list">
                            <!-- Selected and ordered columns will be populated here -->
                        </div>
                        <div class="move-buttons">
                            <button id="moveUpBtn" class="column-control-button">▲ <span class="lang-text" data-key="move-up">Move Up</span></button>
                            <button id="moveDownBtn" class="column-control-button">▼ <span class="lang-text" data-key="move-down">Move Down</span></button>
                        </div>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 1.5rem;">
                    <button id="displayTableBtn" class="action-button"><span class="lang-text" data-key="display-table">Display Table</span></button>
                </div>
            </section>

            <section id="resultSection" class="section hidden">
                <h2 id="result-title">Results Table</h2>
                <div class="control-group">
                    <label id="sort-by-label" for="sortColumn">Sort By:</label>
                    <select id="sortColumn">
                        <option value="">(None)</option>
                    </select>
                    <input type="radio" id="sortAsc" name="sortDirection" value="asc" checked>
                    <label id="sort-asc-label" for="sortAsc">Asc</label>
                    <input type="radio" id="sortDesc" name="sortDirection" value="desc">
                    <label id="sort-desc-label" for="sortDesc">Desc</label>
                </div>
                <div class="control-group">
                    <label id="font-size-label" for="fontSizeInput">PPTX Font Size:</label>
                    <input type="number" id="fontSizeInput" value="12" min="8" max="24">
                </div>
                <div class="button-group">
                    <button id="exportPPTXBtn" class="action-button" disabled><span class="lang-text" data-key="export-pptx">Export to PPTX</span></button>
                </div>
                <div class="table-container">
                    <table id="dataTable">
                        <thead>
                            <tr id="tableHeaderRow">
                                <!-- Table headers will be inserted here -->
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <!-- Table data will be inserted here -->
                        </tbody>
                    </table>
                </div>
                <div class="loading" id="loadingIndicator">
                    <div class="loading-spinner"></div>
                    <p id="loading-text" class="lang-text" data-key="loading-text">Generating PowerPoint file...</p>
                </div>
                <div class="status-message status-info" id="pptStatusMessage"></div>
            </section>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        const translations = {
            en: {
                'main-title': 'Column Selection and Data Export',
                'upload-title': 'Upload Your Data File',
                'select-title': 'Select and Order Columns',
                'available-columns-title': 'Available Columns',
                'selected-columns-title': 'Selected Columns (Order)',
                'move-up': 'Move Up',
                'move-down': 'Move Down',
                'display-table': 'Display Table',
                'result-title': 'Results Table',
                'sort-by-label': 'Sort By:',
                'sort-asc-label': 'Asc',
                'sort-desc-label': 'Desc',
                'font-size-label': 'PPTX Font Size:',
                'export-pptx': 'Export to PPTX',
                'loading-text': 'Generating PowerPoint file...',
                'upload-error': 'Please upload a CSV or XLSX file.',
                'parse-error': 'Error parsing file: ',
                'empty-file-error': 'File is empty or has no identifiable headers.',
                'no-column-selected-error': 'Please select at least one column.',
                'pptx-loading-success': 'PowerPoint library loaded successfully. Ready to export.',
                'pptx-loading-error': 'PowerPoint library failed to load. PPTX export unavailable.',
                'pptx-export-unavailable': 'PowerPoint generation is not available. Please wait for the library to load or refresh the page.',
                'pptx-no-data-to-export': 'No data with content to generate slides for.',
                'pptx-download-success': 'PowerPoint file downloaded successfully! 🎉',
                'pptx-download-error': 'Error generating PowerPoint file: ',
                'remove': 'Remove',
                'add': 'Add',
                'ok': 'OK',
                'cancel': 'Cancel',
                'select-all': '(Select All)',
                'sort-none': '(None)'
            },
            ar: {
                'main-title': 'تحديد الأعمدة وتصدير البيانات',
                'upload-title': 'قم بتحميل ملف البيانات الخاص بك',
                'select-title': 'حدد ورتب الأعمدة',
                'available-columns-title': 'الأعمدة المتاحة',
                'selected-columns-title': 'الأعمدة المحددة (الترتيب)',
                'move-up': 'تحريك للأعلى',
                'move-down': 'تحريك للأسفل',
                'display-table': 'عرض الجدول',
                'result-title': 'جدول النتائج',
                'sort-by-label': 'الفرز حسب:',
                'sort-asc-label': 'تصاعدي',
                'sort-desc-label': 'تنازلي',
                'font-size-label': 'حجم خط ملف PPTX:',
                'export-pptx': 'تصدير إلى PPTX',
                'loading-text': 'جاري إنشاء ملف PowerPoint...',
                'upload-error': 'يرجى تحميل ملف بصيغة CSV أو XLSX.',
                'parse-error': 'خطأ في تحليل الملف: ',
                'empty-file-error': 'الملف فارغ أو لا يحتوي على رؤوس أعمدة واضحة.',
                'no-column-selected-error': 'يرجى تحديد عمود واحد على الأقل.',
                'pptx-loading-success': 'تم تحميل مكتبة PowerPoint بنجاح. جاهز للتصدير.',
                'pptx-loading-error': 'فشل تحميل مكتبة PowerPoint. التصدير غير متاح.',
                'pptx-export-unavailable': 'توليد ملف PowerPoint غير متاح. يرجى الانتظار لتحميل المكتبة أو تحديث الصفحة.',
                'pptx-no-data-to-export': 'لا توجد بيانات ذات محتوى لإنشاء شرائح لها.',
                'pptx-download-success': 'تم تنزيل ملف PowerPoint بنجاح! 🎉',
                'pptx-download-error': 'خطأ في إنشاء ملف PowerPoint: ',
                'remove': 'إزالة',
                'add': 'إضافة',
                'ok': 'موافق',
                'cancel': 'إلغاء',
                'select-all': '(تحديد الكل)',
                'sort-none': '(لا شيء)'
            }
        };

        let currentLanguage = 'en';
        let rawData = [];
        let allHeaders = [];
        let selectedHeaders = [];
        let activeFilters = {};
        let currentlySelectedColumnElement = null;
        let pptxReady = false;

        // Moved DOM element variables to global scope
        const fileInput = document.getElementById('fileInput');
        const languageSwitch = document.getElementById('languageSwitch');
        const columnSelectionSection = document.getElementById('columnSelectionSection');
        const availableColumnsList = document.getElementById('availableColumnsList');
        const selectedColumnsList = document.getElementById('selectedColumnsList');
        const moveUpBtn = document.getElementById('moveUpBtn');
        const moveDownBtn = document.getElementById('moveDownBtn');
        const displayTableBtn = document.getElementById('displayTableBtn');
        const resultSection = document.getElementById('resultSection');
        const tableHeaderRow = document.getElementById('tableHeaderRow');
        const tableBody = document.getElementById('tableBody');
        const exportPPTXBtn = document.getElementById('exportPPTXBtn');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const pptStatusMessage = document.getElementById('pptStatusMessage');
        const sortColumnSelect = document.getElementById('sortColumn');
        const sortDirectionRadios = document.querySelectorAll('input[name="sortDirection"]');
        const fontSizeInput = document.getElementById('fontSizeInput');

        function updateLanguage(lang) {
            currentLanguage = lang;
            document.documentElement.lang = lang;
            document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';

            // Update static elements
            document.getElementById('main-title').textContent = translations[lang]['main-title'];
            document.getElementById('upload-title').textContent = translations[lang]['upload-title'];
            document.getElementById('select-title').textContent = translations[lang]['select-title'];
            document.getElementById('available-columns-title').textContent = translations[lang]['available-columns-title'];
            document.getElementById('selected-columns-title').textContent = translations[lang]['selected-columns-title'];
            document.getElementById('displayTableBtn').querySelector('.lang-text').textContent = translations[lang]['display-table'];
            document.getElementById('result-title').textContent = translations[lang]['result-title'];
            document.getElementById('sort-by-label').textContent = translations[lang]['sort-by-label'];
            document.getElementById('sort-asc-label').textContent = translations[lang]['sort-asc-label'];
            document.getElementById('sort-desc-label').textContent = translations[lang]['sort-desc-label'];
            document.getElementById('font-size-label').textContent = translations[lang]['font-size-label'];
            document.getElementById('exportPPTXBtn').querySelector('.lang-text').textContent = translations[lang]['export-pptx'];
            document.getElementById('loading-text').textContent = translations[lang]['loading-text'];

            // Update dynamic elements
            updateDynamicText();
            renderSelectedColumns();
            if (!columnSelectionSection.classList.contains('hidden') && rawData.length > 0) {
                renderTable();
            }
        }

        function updateDynamicText() {
            // Update button texts
            document.querySelectorAll('.column-item .add-to-selected').forEach(btn => btn.textContent = translations[currentLanguage]['add']);
            document.querySelectorAll('.column-item .remove-from-selected').forEach(btn => btn.textContent = translations[currentLanguage]['remove']);

            // Update sort option
            const sortNoneOption = document.querySelector('#sortColumn option[value=""]');
            if (sortNoneOption) {
                sortNoneOption.textContent = translations[currentLanguage]['sort-none'];
            }
        }

        // Dunctions moved to global scope
        function renderSelectedColumns() {
            const selectedColumnsList = document.getElementById('selectedColumnsList');
            selectedColumnsList.innerHTML = '';
            selectedHeaders.forEach(header => {
                const item = document.createElement('div');
                item.classList.add('column-item', 'draggable');
                item.innerHTML = `
                    <span>${header}</span>
                    <button class="red-button remove-from-selected">${translations[currentLanguage]['remove']}</button>
                `;
                item.dataset.header = header;
                selectedColumnsList.appendChild(item);

                item.addEventListener('click', (e) => {
                    if (e.target.classList.contains('remove-from-selected')) return;
                    if (currentlySelectedColumnElement) {
                        currentlySelectedColumnElement.classList.remove('selected');
                    }
                    currentlySelectedColumnElement = item;
                    item.classList.add('selected');
                });
            });

            selectedColumnsList.querySelectorAll('.remove-from-selected').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const headerToRemove = e.target.closest('.column-item').dataset.header;
                    selectedHeaders = selectedHeaders.filter(h => h !== headerToRemove);
                    delete activeFilters[headerToRemove];
                    renderSelectedColumns();
                    if (currentlySelectedColumnElement && currentlySelectedColumnElement.dataset.header === headerToRemove) {
                        currentlySelectedColumnElement = null;
                    }
                });
            });
        }
        
        function renderTable() {
            const tableHeaderRow = document.getElementById('tableHeaderRow');
            const tableBody = document.getElementById('tableBody');
            const resultSection = document.getElementById('resultSection');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const exportPPTXBtn = document.getElementById('exportPPTXBtn');
            const pptStatusMessage = document.getElementById('pptStatusMessage');
            const sortColumnSelect = document.getElementById('sortColumn');

            if (selectedHeaders.length === 0) {
                const customAlert = document.createElement('div');
                customAlert.classList.add('status-message', 'status-error');
                customAlert.textContent = translations[currentLanguage]['no-column-selected-error'];
                document.querySelector('.main-container').appendChild(customAlert);
                setTimeout(() => customAlert.remove(), 3000);
                return;
            }

            tableHeaderRow.innerHTML = '';
            tableBody.innerHTML = '';

            const sortColumn = sortColumnSelect.value;
            const sortDirection = document.querySelector('input[name="sortDirection"]:checked').value;

            const filteredData = filterData(rawData);
            const sortedAndFilteredData = sortData(filteredData, sortColumn, sortDirection);
            const dateTimeColumns = ['التاريخ (الي)', 'التاريخ (من)', 'وقت البدء', 'وقت الإكمال'];

            selectedHeaders.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                
                const filterIcon = document.createElement('span');
                filterIcon.classList.add('filter-icon');
                filterIcon.textContent = '▼';
                filterIcon.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showFilterDropdown(th, header);
                });
                th.appendChild(filterIcon);

                tableHeaderRow.appendChild(th);
            });

            sortedAndFilteredData.forEach(row => {
                const tr = document.createElement('tr');
                selectedHeaders.forEach(header => {
                    const td = document.createElement('td');
                    let cellValue = row[header] !== undefined ? row[header] : '';

                    if (dateTimeColumns.includes(header)) {
                        cellValue = formatDate(cellValue);
                    }
                    td.textContent = cellValue;
                    tr.appendChild(td);
                });
                tableBody.appendChild(tr);
            });

            resultSection.classList.remove('hidden');
            loadingIndicator.style.display = 'none';

            if (pptxReady && window.PptxGenJS) {
                exportPPTXBtn.disabled = false;
                pptStatusMessage.textContent = translations[currentLanguage]['pptx-loading-success'];
                pptStatusMessage.className = 'status-message status-success';
            } else {
                exportPPTXBtn.disabled = true;
                pptStatusMessage.textContent = translations[currentLanguage]['pptx-loading-error'];
                pptStatusMessage.className = 'status-message status-error';
            }
        }

        // The rest of the functions
        function loadPptxGenJS() {
            return new Promise((resolve, reject) => {
                if (window.PptxGenJS) {
                    resolve(window.PptxGenJS);
                    return;
                }
                
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js';
                script.onload = () => {
                    if (window.PptxGenJS) {
                        resolve(window.PptxGenJS);
                    } else {
                        reject(new Error('PptxGenJS not found after loading'));
                    }
                };
                script.onerror = () => reject(new Error('Failed to load PptxGenJS'));
                document.head.appendChild(script);
            });
        }

        function excelDateToJSDate(excelSerial) {
            if (typeof excelSerial !== 'number' || excelSerial <= 0) {
                return null;
            }

            let days = excelSerial;
            if (days > 60) {
                days--;
            }

            const msPerDay = 24 * 60 * 60 * 1000;
            const excelEpoch = new Date('1899-12-30T00:00:00.000Z');
            const jsDate = new Date(excelEpoch.getTime() + (days * msPerDay));
            return jsDate;
        }

        function formatDate(value) {
            if (value === null || value === undefined || String(value).trim() === '') {
                return '';
            }

            let date;
            let dateString = String(value).trim();

            if (typeof value === 'number' && value > 1 && value < 2958466) {
                date = excelDateToJSDate(value);
            } else {
                function tryParseStringDate(str) {
                    let matchYMD = str.match(/^(\d{4})[/-](\d{1,2})[/-](\d{1,2})([\sT].*)?$/);
                    if (matchYMD) {
                        let d = new Date(matchYMD[1], matchYMD[2] - 1, matchYMD[3]);
                        if (!isNaN(d.getTime())) return d;
                    }

                    let matchDMY = str.match(/^(\d{1,2})[/-](\d{1,2})[/-](\d{4})([\sT].*)?$/);
                    if (matchDMY) {
                        let d = new Date(matchDMY[3], matchDMY[2] - 1, matchDMY[1]);
                        if (!isNaN(d.getTime())) return d;
                    }

                    let matchMDY = str.match(/^(\d{1,2})[/-](\d{1,2})[/-](\d{4})([\sT].*)?$/);
                    if (matchMDY) {
                        let d = new Date(matchMDY[3], matchMDY[1] - 1, matchMDY[2]);
                        if (!isNaN(d.getTime())) return d;
                    }

                    let d = new Date(str);
                    if (!isNaN(d.getTime())) return d;
                    return null;
                }
                date = tryParseStringDate(dateString);
            }

            if (date) {
                return date.toLocaleDateString('en-CA', { year: 'numeric', month: '2-digit', day: '2-digit' });
            }
            return '';
        }

        function parseCSV(data) {
            Papa.parse(data, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    rawData = results.data;
                    allHeaders = results.meta.fields;
                    initializeColumnSelectors();
                },
                error: function(err) {
                    const customAlert = document.createElement('div');
                    customAlert.classList.add('status-message', 'status-error');
                    customAlert.textContent = translations[currentLanguage]['parse-error'] + err.message;
                    document.querySelector('.main-container').appendChild(customAlert);
                    setTimeout(() => customAlert.remove(), 3000);
                }
            });
        }

        function parseXLSX(data) {
            try {
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];

                let headerRow = XLSX.utils.sheet_to_json(worksheet, { header: 1, range: 0 })[0];
                if (headerRow && headerRow.length > 0) {
                    allHeaders = headerRow;
                    rawData = XLSX.utils.sheet_to_json(worksheet, { header: allHeaders, raw: false, defval: null });
                } else {
                    allHeaders = [];
                    rawData = [];
                    const customAlert = document.createElement('div');
                    customAlert.classList.add('status-message', 'status-error');
                    customAlert.textContent = translations[currentLanguage]['empty-file-error'];
                    document.querySelector('.main-container').appendChild(customAlert);
                    setTimeout(() => customAlert.remove(), 3000);
                }
                initializeColumnSelectors();
            } catch (error) {
                const customAlert = document.createElement('div');
                customAlert.classList.add('status-message', 'status-error');
                customAlert.textContent = translations[currentLanguage]['parse-error'] + error.message;
                document.querySelector('.main-container').appendChild(customAlert);
                setTimeout(() => customAlert.remove(), 3000);
                console.error('XLSX parse error:', error);
            }
        }

        function initializeColumnSelectors() {
            availableColumnsList.innerHTML = '';
            selectedColumnsList.innerHTML = '';
            sortColumnSelect.innerHTML = `<option value="">${translations[currentLanguage]['sort-none']}</option>`;
            selectedHeaders = [];
            activeFilters = {};
            columnSelectionSection.classList.remove('hidden');
            resultSection.classList.add('hidden');

            allHeaders.forEach(header => {
                const item = document.createElement('div');
                item.classList.add('column-item');
                item.innerHTML = `
                    <span>${header}</span>
                    <button class="column-control-button add-to-selected">${translations[currentLanguage]['add']}</button>
                `;
                item.dataset.header = header;
                availableColumnsList.appendChild(item);

                const sortOption = document.createElement('option');
                sortOption.value = header;
                sortOption.textContent = header;
                sortColumnSelect.appendChild(sortOption);
            });

            availableColumnsList.querySelectorAll('.add-to-selected').forEach(button => {
                button.addEventListener('click', (e) => {
                    const header = e.target.closest('.column-item').dataset.header;
                    if (!selectedHeaders.includes(header)) {
                        selectedHeaders.push(header);
                        renderSelectedColumns();
                    }
                });
            });
        }
        
        function filterData(data) {
            let filteredData = [...data];
            for (const column in activeFilters) {
                if (activeFilters[column].length > 0) {
                    filteredData = filteredData.filter(row => activeFilters[column].includes(String(row[column])));
                }
            }
            return filteredData;
        }

        function sortData(data, column, direction) {
            if (!column) return data;
            
            const sorted = [...data].sort((a, b) => {
                let valA = a[column];
                let valB = b[column];

                const dateTimeColumns = ['التاريخ (الي)', 'التاريخ (من)', 'وقت البدء', 'وقت الإكمال'];

                if (valA === null || valA === undefined || valA === '') return 1;
                if (valB === null || valB === undefined || valB === '') return -1;
                
                let comparison = 0;

                if (dateTimeColumns.includes(column)) {
                    const dateA = new Date(valA);
                    const dateB = new Date(valB);
                    comparison = dateA - dateB;
                } else if (!isNaN(parseFloat(valA)) && isFinite(valA) && !isNaN(parseFloat(valB)) && isFinite(valB)) {
                    comparison = parseFloat(valA) - parseFloat(valB);
                } else {
                    comparison = String(valA).localeCompare(String(valB), currentLanguage, { sensitivity: 'base' });
                }

                return direction === 'asc' ? comparison : -comparison;
            });
            return sorted;
        }

        function showFilterDropdown(th, header) {
            document.querySelectorAll('.filter-dropdown').forEach(d => d.remove());

            const uniqueValues = [...new Set(rawData.map(row => String(row[header])))].sort();
            
            const dropdown = document.createElement('div');
            dropdown.classList.add('filter-dropdown');
            dropdown.addEventListener('click', (e) => e.stopPropagation());

            const selectAllItem = document.createElement('div');
            selectAllItem.classList.add('filter-item');
            selectAllItem.innerHTML = `<input type="checkbox" id="selectAll"><label for="selectAll">${translations[currentLanguage]['select-all']}</label>`;
            dropdown.appendChild(selectAllItem);

            const valueList = document.createElement('div');
            uniqueValues.forEach(value => {
                const filterItem = document.createElement('div');
                filterItem.classList.add('filter-item');
                const isChecked = !activeFilters[header] || activeFilters[header].length === 0 || activeFilters[header].includes(value);
                filterItem.innerHTML = `<input type="checkbox" value="${value}" ${isChecked ? 'checked' : ''}><label>${value}</label>`;
                valueList.appendChild(filterItem);
            });
            dropdown.appendChild(valueList);

            const buttons = document.createElement('div');
            buttons.classList.add('filter-buttons');
            buttons.innerHTML = `
                <button class="action-button ok-btn">${translations[currentLanguage]['ok']}</button>
                <button class="red-button cancel-btn">${translations[currentLanguage]['cancel']}</button>
            `;
            dropdown.appendChild(buttons);

            th.appendChild(dropdown);

            const selectAllCheckbox = dropdown.querySelector('#selectAll');
            const valueCheckboxes = dropdown.querySelectorAll('input[type="checkbox"]:not(#selectAll)');
            selectAllCheckbox.checked = activeFilters[header] === undefined || activeFilters[header].length === 0 || activeFilters[header].length === uniqueValues.length;
            selectAllCheckbox.addEventListener('change', (e) => {
                valueCheckboxes.forEach(cb => cb.checked = e.target.checked);
            });
            
            dropdown.querySelector('.ok-btn').addEventListener('click', () => {
                const selectedValues = Array.from(valueCheckboxes).filter(cb => cb.checked).map(cb => cb.value);
                activeFilters[header] = selectedValues;
                dropdown.remove();
                renderTable();
            });
            dropdown.querySelector('.cancel-btn').addEventListener('click', () => {
                dropdown.remove();
            });
        }


        document.addEventListener('DOMContentLoaded', function() {
            
            // Initial language update
            updateLanguage(languageSwitch.checked ? 'ar' : 'en');
            
            languageSwitch.addEventListener('change', (e) => {
                updateLanguage(e.target.checked ? 'ar' : 'en');
            });
            
            document.addEventListener('click', (e) => {
                const dropdowns = document.querySelectorAll('.filter-dropdown');
                dropdowns.forEach(dropdown => {
                    const parentTh = dropdown.closest('th');
                    if (parentTh && !parentTh.contains(e.target)) {
                        dropdown.remove();
                    }
                });
            });

            loadPptxGenJS().then(() => {
                pptxReady = true;
                pptStatusMessage.textContent = translations[currentLanguage]['pptx-loading-success'];
                pptStatusMessage.className = 'status-message status-success';
                exportPPTXBtn.disabled = false;
            }).catch(error => {
                console.error('Failed to load PptxGenJS:', error);
                pptStatusMessage.textContent = translations[currentLanguage]['pptx-loading-error'];
                pptStatusMessage.className = 'status-message status-error';
                exportPPTXBtn.disabled = true;
            });
            
            fileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const data = e.target.result;
                    const fileName = file.name;

                    if (fileName.endsWith('.csv')) {
                        parseCSV(data);
                    } else if (fileName.endsWith('.xlsx')) {
                        parseXLSX(data);
                    } else {
                        const customAlert = document.createElement('div');
                        customAlert.classList.add('status-message', 'status-error');
                        customAlert.textContent = translations[currentLanguage]['upload-error'];
                        document.querySelector('.main-container').appendChild(customAlert);
                        setTimeout(() => customAlert.remove(), 3000);
                    }
                };

                if (file.name.endsWith('.xlsx')) {
                    reader.readAsArrayBuffer(file);
                } else {
                    reader.readAsText(file);
                }
            });

            sortColumnSelect.addEventListener('change', renderTable);
            sortDirectionRadios.forEach(radio => radio.addEventListener('change', renderTable));
            displayTableBtn.addEventListener('click', renderTable);

            moveUpBtn.addEventListener('click', () => {
                if (currentlySelectedColumnElement) {
                    const header = currentlySelectedColumnElement.dataset.header;
                    const index = selectedHeaders.indexOf(header);
                    if (index > 0) {
                        [selectedHeaders[index], selectedHeaders[index - 1]] = [selectedHeaders[index - 1], selectedHeaders[index]];
                        renderSelectedColumns();
                        const newElement = selectedColumnsList.querySelector(`[data-header="${header}"]`);
                        if (newElement) {
                            newElement.classList.add('selected');
                            currentlySelectedColumnElement = newElement;
                        }
                    }
                }
            });

            moveDownBtn.addEventListener('click', () => {
                if (currentlySelectedColumnElement) {
                    const header = currentlySelectedColumnElement.dataset.header;
                    const index = selectedHeaders.indexOf(header);
                    if (index < selectedHeaders.length - 1) {
                        [selectedHeaders[index], selectedHeaders[index + 1]] = [selectedHeaders[index + 1], selectedHeaders[index]];
                        renderSelectedColumns();
                        const newElement = selectedColumnsList.querySelector(`[data-header="${header}"]`);
                        if (newElement) {
                            newElement.classList.add('selected');
                            currentlySelectedColumnElement = newElement;
                        }
                    }
                }
            });

            exportPPTXBtn.addEventListener('click', async () => {
                if (selectedHeaders.length === 0) {
                    const customAlert = document.createElement('div');
                    customAlert.classList.add('status-message', 'status-error');
                    customAlert.textContent = translations[currentLanguage]['no-column-selected-error'];
                    document.querySelector('.main-container').appendChild(customAlert);
                    setTimeout(() => customAlert.remove(), 3000);
                    return;
                }

                if (!pptxReady || !window.PptxGenJS) {
                    const customAlert = document.createElement('div');
                    customAlert.classList.add('status-message', 'status-error');
                    customAlert.textContent = translations[currentLanguage]['pptx-export-unavailable'];
                    document.querySelector('.main-container').appendChild(customAlert);
                    setTimeout(() => customAlert.remove(), 3000);
                    return;
                }

                pptStatusMessage.textContent = '';
                loadingIndicator.style.display = 'block';
                exportPPTXBtn.disabled = true;

                setTimeout(async () => {
                    try {
                        let pptx = new PptxGenJS();
                        pptx.layout = 'LAYOUT_WIDE';
                        const pptxFontSize = parseInt(fontSizeInput.value, 10);

                        const dateTimeColumns = ['التاريخ (الي)', 'التاريخ (من)', 'وقت البدء', 'وقت الإكمال'];

                        const filteredAndSortedData = filterData(rawData).sort((a, b) => {
                            const sortColumn = sortColumnSelect.value;
                            const sortDirection = document.querySelector('input[name="sortDirection"]:checked').value;
                            return sortData([a, b], sortColumn, sortDirection)[0] === a ? -1 : 1;
                        });

                        const dataToPresent = filteredAndSortedData.filter(row =>
                            selectedHeaders.some(header => row[header] !== undefined && String(row[header]).trim() !== '')
                        );

                        if (dataToPresent.length === 0) {
                            pptStatusMessage.textContent = translations[currentLanguage]['pptx-no-data-to-export'];
                            pptStatusMessage.className = 'status-message status-error';
                            loadingIndicator.style.display = 'none';
                            exportPPTXBtn.disabled = false;
                            return;
                        }

                        dataToPresent.forEach((row, recordIndex) => {
                            let slide = pptx.addSlide();
                            slide.background = { fill: 'FFFFFF' };

                            slide.addText('المعهد العالي للهندسة والتكنولوجيا بكفر الشيخ', {
                                x: 0,
                                y: 0.5,
                                w: '100%',
                                h: 0.5,
                                fontSize: 18,
                                color: '1E3A8A',
                                align: 'center',
                                valign: 'middle',
                                rtl: true,
                                bold: true
                            });
                            
                            const recordTableData = [];

                            selectedHeaders.forEach(header => {
                                let cellValue = row[header] !== undefined ? row[header] : '';
                                
                                if (dateTimeColumns.includes(header)) {
                                    cellValue = formatDate(cellValue);
                                }

                                recordTableData.push([
                                    {
                                        text: String(cellValue),
                                        options: {
                                            fontFace: 'Arial',
                                            fontSize: pptxFontSize,
                                            color: '1F2937',
                                            fill: 'FFFFFF',
                                            align: 'right',
                                            valign: 'top',
                                            rtl: true,
                                            margin: [0.1, 0.1, 0.1, 0.1],
                                            breakLine: true,
                                            bold: true
                                        }
                                    },
                                    {
                                        text: header,
                                        options: {
                                            bold: true,
                                            fontFace: 'Arial',
                                            fontSize: pptxFontSize + 2,
                                            color: '1E3A8A',
                                            fill: 'A7D9FC',
                                            align: 'right',
                                            valign: 'middle',
                                            rtl: true,
                                            margin: [0.1, 0.1, 0.1, 0.1]
                                        }
                                    }
                                ]);
                            });

                            slide.addTable(recordTableData, {
                                x: 0.8,
                                y: 1.4,
                                w: 11.4,
                                h: 5.2,
                                border: { pt: 1, color: '000000' },
                                colW: [7.6, 3.8],
                                rowH: recordTableData.map(() => 0.4),
                                autoPage: false,
                                fill: 'F8FAFC',
                                rtl: true
                            });

                            let blankSlide1 = pptx.addSlide();
                            blankSlide1.background = { fill: 'FFFFFF' };
                            blankSlide1.addText('فاصل', {
                                x: 0, y: '50%', w: '100%', h: 1,
                                fontSize: 32,
                                color: 'A3A3A3',
                                align: 'center',
                                valign: 'middle',
                                rtl: true,
                                bold: true
                            });

                            let blankSlide2 = pptx.addSlide();
                            blankSlide2.background = { fill: 'FFFFFF' };
                            blankSlide2.addText('تابع', {
                                x: 0, y: '50%', w: '100%', h: 1,
                                fontSize: 32,
                                color: 'A3A3A3',
                                align: 'center',
                                valign: 'middle',
                                rtl: true,
                                bold: true
                            });
                        });

                        await pptx.writeFile({ fileName: 'detailed-records-report.pptx' });
                        pptStatusMessage.textContent = translations[currentLanguage]['pptx-download-success'];
                        pptStatusMessage.className = 'status-message status-success';
                    } catch (error) {
                        console.error("Error generating PowerPoint file:", error);
                        pptStatusMessage.textContent = `${translations[currentLanguage]['pptx-download-error']} ${error.message}`;
                        pptStatusMessage.className = 'status-message status-error';
                    } finally {
                        loadingIndicator.style.display = 'none';
                        exportPPTXBtn.disabled = false;
                    }
                }, 100);
            });
        });
    </script>
</body>
</html>
